name: Milestone Assignment Check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize, milestoned, demilestoned]

permissions:
  pull-requests: read
  checks: write

jobs:
  check-milestone:
    runs-on: ubuntu-latest
    steps:
      - name: Check milestone assignment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const hasMilestone = pr.milestone !== null;

            // Create check run
            const { data: check } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Milestone Assignment',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: hasMilestone ? 'success' : 'failure',
              output: {
                title: hasMilestone ? 'Milestone Assigned' : 'No Milestone Assigned',
                summary: hasMilestone && pr.milestone
                  ? 'This PR is assigned to milestone: ' + pr.milestone.title
                  : 'This PR must be assigned to a milestone before merging. The auto-label workflow should assign this automatically, but you can also assign it manually.'
              }
            });

            if (!hasMilestone) {
              core.setFailed('PR must have a milestone assigned');
            }
